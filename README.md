# Horae - 时光记忆 v1.5.5 | SillyTavern 记忆增强插件

![Image](https://github.com/SenriYuki/SillyTavern-Horae/blob/main/HoraeLogo.jpg)

> *Horae（荷赖）— 希腊神话中掌管时序的女神*

长篇 RP 玩家的老毛病你一定遇到过 —— AI 的记忆约等于金鱼：昨天的事说成今天早上，连几天前发生的事都永远说是昨天；上一幕穿校服下一幕突然便服；NPC关系倒置；送出去的礼物凭空消失，丢掉的东西又回到手里。

**Horae 用结构化的时间锚点，给你的 AI 装上一本靠谱的记忆账本。**

使用注意事项：小铅笔或底部栏编辑完插件标签并保存后，记得像玩变量卡一样，按底部栏的刷新键，插件会读取修改过的内容做更新。

---

## 亮点功能

**场景记忆 —— 酒馆不再一夜变样（新）**
AI 描写同一个地点，上一回有壁炉这一回没了？场景记忆会记录地点的固定物理特征，下次进入同一场景时自动注入。智能匹配地名（「酒馆·大厅」自动回退到「酒馆」），只发送匹配到的那一条描述，未命中时零注入。

**情绪 & 关系网络 —— AI 读懂人际场（新）**
情绪追踪让 AI 记住角色当前的心理状态，不再前一秒哭后一秒笑。关系网络记录人物之间的关系类型和变化，再也不会把敌人写成朋友。两者都是变化驱动，没变化时零输出。

**自动摘要 —— 长篇自动省 Token（新）**
聊了几百楼还在全量发送？自动摘要在后台自动压缩旧消息为一段摘要，原始楼层 `/hide` 省 Token。摘要和原始时间线可随时一键切换，所见即所发。还能配一个低成本的**独立 API** 做真并行，摘要生成完全不占主连接。

**美化自定义**
独立的**主题系统**，内置三套预设，支持一键切换日夜模式。支持导入/导出主题 JSON 与社区分享，还能手写 CSS 代码微调。（⚠️做 Horae 插件的美化不用跟我要授权，请随意。）

**AI 智能摘要**
旧档案没用过 Horae？一键批量扫描全部历史消息，AI 自动提取剧情事件和物品变化，生成完整的时间线。支持自定义每批 Token 上限适配不同模型，不满意可一键撤销。

**告别"永远的昨天"**
插件自动计算相对时间，注入"昨天"、"上周三"、"上个月15号"这样的生活化表述。AI 终于能分清前天和上周了。支持现代、历史、奇幻架空等多种日历体系。

**衣服不再乱穿**
每位角色的当前穿着被锁定记录，且只发送在场角色的服装。角色不会再莫名其妙换昨天的衣服，也不会把不在场的人的衣服发给 AI 浪费 token。

**NPC 不会越写越糊**
外貌、性格、关系等字段独立追踪。年龄还会随剧情时间自动推进。严格订立了关系的 prompt，不再上一秒 Char 欠 User 钱，下一秒 AI 输出说是 User 欠 Char 钱来颠倒关系。

**物品栏终于靠谱了**
带唯一编号的物品系统，分一般/重要/关键三级。智能解析数量变化（5斤→4斤），自动检测"已消耗"等状态并移除。

**待办事项防遗忘**
AI 可以自动记录剧情中的约定和伏笔，完成后自动删除。再也不用担心 AI 忘记两周前约好的约会。

**宝宝辅食级自定义表格**
Excel 风格的自由表格，想加行加行想加列加列，配上填写提示词让 AI 自动填。课程表、角色关系、任务清单……你能想到的都能做。删除消息时 AI 填的内容自动回退，你自己填的始终保留。

**变化驱动，省 Token**
AI 只输出本回合变化的信息，不再每次重复整个状态。每种数据都有明确的触发规则，减少无效输出。**不用额外耗费生成次数** —— 插件在 AI 正常回复时自动解析记忆节点，零额外开销。

**截断/改写也不怕**
中途被截断或自己手动改写了部分剧情？底部栏内置 **AI 分析**功能，只需一次生成就能智能补全该条消息的记忆节点。

**界面简单，萌新友好**
底部栏一目了然，顶部面板分页清晰。无需复杂配置，安装即用。

**发送内容自由控制**
在设置中自由选择哪些数据发送给 AI、哪些不发送 —— 不需要角色追踪？关掉。不需要物品栏？关掉。按需组合，节省 token。

---

## 快速安装

1. 打开 SillyTavern → 顶部扩展面板（积木图标）→ 「安装扩展」
2. 粘贴本仓库的 Git 链接，点击安装
3. 安装完成后刷新页面即可使用

> 配套正则会在插件首次加载时**自动注入**，无需手动导入。



---

## v1.1.0 更新内容

- **AI 智能摘要**：批量分析历史消息，自动提取剧情事件和物品，支持自定义 Token 分批上限，可一键撤销
- **Token计数器**：显示发送给AI的总prompt量，位置在设置下方。附带一提，目前插件果奔时发送prompt 3,591 Token
- **swipe适配**：修复了右滑生成新分页时，旧分页的记忆数据会被带入新生成的问题。现在swipe生成时会自动排除当前分页的旧记忆，确保AI基于正确的上下文生成全新的剧情分支
- **美化兼容**：插件 UI 样式与外部美化主题隔离，不再出现黑底黑字或白底白字
- **正则修改**：把<horaeevent>也设置为不发送给AI，更省Token
- **描述修正**：把某些功能的描述更正为更准确的描述方式

---

## v1.2.0 更新内容

- **自定义提示词**：设置中新增提示词编辑器，可自由修改系统注入提示词和 AI 摘要提示词，支持 `{{user}}`/`{{char}}` 变量，可以一键恢复默认，方便微调
- **AI 摘要功能新增**：现在可以中断生成了，并配置了弹窗新增「NPC 角色信息」和「好感度」勾选项。默认关闭，按需开启
- **摘要审阅弹窗**：AI 智能摘要完成后弹出审阅视窗，按「剧情轨迹 / 物品 / 角色 / 好感度」分类展示结果。逐条删除不满意的内容，点「补充摘要」只对删除项重跑 AI
- **好感度显示开关**：好感度区域新增小眼睛按钮，可点击隐藏/显示角色好感度
- **好感度删除**：编辑好感度弹窗新增删除键，可以自行删除AI生成错误产生错误的项目
- **美化兼容**：强调了CHECKBOX内部的字色，不再出现白底白勾

---

## v1.3.0 更新内容

- **全局表格**：自定义表格新增「全局」和「本地」两种作用域。全局表格跨角色卡共享，适合记录固定数据（如角色 ID 表）。点击表格名称前的图标可切换
- **行列锁定**：右键/长按表格单元格可锁定行、列或单个格子，防止 AI 修改。锁定内容在 prompt 中标记 🔒，AI 会跳过写入
- **一键清空表格**：表格操作栏新增橡皮擦按钮，清除所有数据区内容但保留表头，方便让 AI 重新填表
- **主题系统**：内置「樱花粉」「森林绿」「海洋蓝」三套预设主题，下拉即用。支持导入/导出自定义美化 JSON 文件，方便社区共享主题
- **美化导航**：新增 `THEME.md` 文档，列出全部 CSS 变量、主要容器类名和美化文件格式，方便用户自制主题
- **日夜模式**：设置中可切换日间/夜间模式，仅影响插件界面
- **自定义 CSS**：设置中可输入额外 CSS 代码微调插件样式
- **右键菜单修复**：修复右键菜单透明的问题（CSS 变量作用域未覆盖 `document.body` 级元素）
- **样式隔离增强**：所有按钮替换为插件专属类名，顶栏图标不再受浅色模式影响
- **消息面板宽度**：设置中可自定义消息面板宽度（50-100%）
- **正则置底**：插件正则启动时自动移至列表末尾，减少与其他正则冲突
- **时间线多选**：时间线事件支持长按多选批量删除（避免误触做了较长的触发时间）

---

## v1.4.0 更新内容

- **好感度小数点支持**：好感度数值全面支持小数，兼容世界书等以小数步进的好感度系统
- **顶部图标开关**：设置中新增「显示顶部导航栏图标」开关。可通过扩展面板（积木图标）中的「Horae 时光记忆」栏位重新开启
- **时间线插入功能**：长按时间线事件弹出操作菜单，支持在上方/下方添加事件或插入摘要页。摘要页用于替代被删除的中间时间线，节省 Token 的同时保留关键信息
- **时间线多选改进**：多选模式改为点击顶部按钮切换（原长按触发已改为插入菜单）
- **摘要页**：新增「摘要」事件类型，无时间戳显示，空白状态提示用户"请勿删除开头时间线"
- **表格填写提示词自定义**：自定义提示词区新增「表格填写规则提示词」编辑器，可自由修改 AI 填表规则，支持一键恢复默认
- **表格 AI 理解增强**：发送给 AI 的表格数据现带有坐标标注（如 `[1,2]内容`）和尺寸声明，大幅减少 AI 填错位的问题
- **表格数据清理修复**：删除表格或一键清空时，同步清除所有消息中的 AI 历史填写记录（tableContributions）和基线快照（baseData），彻底杜绝旧数据回流

---

## v1.5.0 更新内容

本次更新围绕 RP「精细度」与「长篇省 Token」展开。

### 新增功能

- **情绪/心理状态追踪**：追踪在场角色的情绪变化（如「紧张/不安」「开心/期待」）。底部栏自动显示当前角色的情绪标签。**Token 消耗极低**——AI 仅在情绪发生明显变化时才输出 `mood:` 标签（通常 10-20 token），无变化时零输出。设置中可开关
- **关系网络**：记录角色之间的关系（朋友、恋人、上下级、宿敌等）。NPC 页面底部显示关系列表，支持手动编辑。底部栏的关系展示**完全由插件从数据库读取渲染，不消耗 AI 输出 Token**。AI 端采用变化驱动：仅在关系变化时输出 `rel:` 标签，已有关系无变化时零输出。设置中可开关
- **场景记忆**：记录地点的固定物理特征，保持跨回合场景描写一致。**智能检索**——插件根据当前地点名匹配已记录的场景描述，仅发送匹配到的那一条（通常 50-150 字），而非把所有地点记忆全部发送。未匹配到任何地点时零注入。支持复合地名回退匹配（如「酒馆·大厅」→「酒馆」）
- **自动摘要 & 隐藏**：设置中开启后，当未压缩消息数超过阈值时自动触发全文摘要。摘要完成后原始消息楼层被 `/hide` 省 Token，时间线中出现摘要卡片。可随时点击按钮在「摘要视图」和「原始时间线」之间切换，所见即所发
- **独立 API（真并行）**：自动摘要可配置独立的 OpenAI 兼容端点（填入 API 地址 / 密钥 / 模型名称即可）。摘要生成通过直接 HTTP 请求，完全不占用酒馆主连接，实现与 AI 回复的真并行。支持 OpenAI、DeepSeek、OpenRouter 等所有兼容端点
- **剧情压缩取消按钮**：事件压缩和全文摘要均新增取消按钮，点击后立即中断后端 API 请求（与 AI 智能摘要的取消按钮一致）
- **表格分支继承**：开分支或回退消息时，表格数据只继承到该节点为止的 AI 填写和用户手动编辑。例如在 #10 开分支，只继承 #10 之前的表格数据，不会带入后续填写

### 改进

- **全局表格数据按卡分离**：全局表格的结构（表头、名称、提示词、锁定）跨角色卡共享，但填写数据按角色卡独立存储。切换卡片不再继承其他卡的表格数据
- **智能记忆压缩**：在时间线多选模式下可将多条事件交给 AI 压缩合并为一条摘要，支持摘要视图与原始时间线双向切换
- 系统提示词编辑器中的默认文本会根据当前启用的功能动态更新（如启用关系网络后 `<horae>` 标签格式区自动出现 `rel:` 行）

### UI / UX

- 修复 `--horae-surface` 未定义变量，改用 `--horae-bg-secondary`。**已有的自定义美化不受影响**
- THEME.md 补充了新增选择器文档

### ⚠️ 升级提醒

如果你之前**自定义过系统注入提示词**，升级到 v1.5.0 后请进入设置 → 自定义提示词，点击各栏位旁的 **🔄 重置** 按钮恢复为最新默认值。因为新增的场景记忆、情绪追踪、关系网络功能需要在提示词中声明对应的标签格式（`scene_desc:`、`mood:`、`rel:`），旧的自定义提示词中缺少这些声明会导致 AI 不输出新标签。

如果你没有自定义过提示词（使用默认值），则无需操作，插件会自动使用最新的默认提示词。

---

## 兼容性

- **SillyTavern**: 1.12.6+（AI分析功能需求1.13.5+）
- **平台**: 电脑端 + 移动端双端适配

---

有 bug 或建议欢迎反馈！

**作者：SenriYuki**
