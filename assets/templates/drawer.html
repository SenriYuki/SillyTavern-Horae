<!-- Horae 主抽屉面板 -->
<div id="horae_drawer" class="drawer">
    <div class="drawer-toggle">
        <div id="horae_drawer_icon" class="drawer-icon fa-regular fa-clock fa-fw closedIcon interactable" title="Horae - 时光记忆" tabindex="0"></div>
    </div>
    <div id="horae_drawer_content" class="drawer-content closedDrawer">
        <!-- 头部 -->
        <div class="drawer-header">
            <div class="horae-title">
                <i class="fa-regular fa-clock"></i>
                Horae 时光记忆
            </div>
            <span class="horae-version">v1.4.0</span>
        </div>
        
        <!-- 标签页导航 -->
        <div class="horae-tabs">
            <button class="horae-tab active" data-tab="status">
                <i class="fa-solid fa-gauge"></i>
                <span>状态</span>
            </button>
            <button class="horae-tab" data-tab="timeline">
                <i class="fa-solid fa-timeline"></i>
                <span>时间线</span>
            </button>
            <button class="horae-tab" data-tab="characters">
                <i class="fa-solid fa-users"></i>
                <span>角色</span>
            </button>
            <button class="horae-tab" data-tab="items">
                <i class="fa-solid fa-box-open"></i>
                <span>物品</span>
            </button>
            <button class="horae-tab" data-tab="settings">
                <i class="fa-solid fa-gear"></i>
                <span>设置</span>
            </button>
        </div>
        
        <!-- 标签页内容 -->
        <div class="horae-tab-contents">
            <!-- 状态页 -->
            <div id="horae-tab-status" class="horae-tab-content active">
                <div class="horae-state-section">
                    <div class="horae-section-header">
                        <i class="fa-regular fa-clock"></i>
                        当前时间
                    </div>
                    <div class="horae-time-display">
                        <span id="horae-current-date">--/--</span>
                        <span id="horae-current-time">--:--</span>
                    </div>
                </div>
                
                <div class="horae-state-section">
                    <div class="horae-section-header">
                        <i class="fa-solid fa-location-dot"></i>
                        当前地点
                    </div>
                    <div class="horae-location-display">
                        <span id="horae-current-location">未设置</span>
                        <span id="horae-current-atmosphere" class="horae-atmosphere-badge"></span>
                    </div>
                </div>
                
                <div class="horae-state-section">
                    <div class="horae-section-header">
                        <i class="fa-solid fa-shirt"></i>
                        角色服装
                    </div>
                    <div id="horae-costumes-list" class="horae-costume-list">
                        <div class="horae-empty-hint">暂无服装记录</div>
                    </div>
                </div>
                
                <div class="horae-state-section">
                    <div class="horae-section-header">
                        <i class="fa-solid fa-cube"></i>
                        物品追踪
                    </div>
                    <div id="horae-items-quick" class="horae-items-quick">
                        <div class="horae-empty-hint">暂无物品追踪</div>
                    </div>
                </div>
                
                <div class="horae-action-buttons">
                    <button id="horae-btn-refresh" class="horae-data-btn primary">
                        <i class="fa-solid fa-rotate"></i>
                        <span>刷新</span>
                    </button>
                </div>
            </div>
            
            <!-- 时间线页 -->
            <div id="horae-tab-timeline" class="horae-tab-content">
                <!-- 待办事项区域 -->
                <div class="horae-agenda-section">
                    <div class="horae-agenda-header">
                        <span><i class="fa-solid fa-list-check"></i> 待办事项</span>
                        <button id="horae-btn-add-agenda" class="horae-icon-btn small" title="添加待办">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                    <!-- 待办多选模式工具栏 -->
                    <div id="horae-agenda-multiselect-bar" class="horae-multiselect-bar" style="display: none;">
                        <div class="horae-multiselect-info">
                            <span id="horae-agenda-selected-count">0</span> 项已选
                        </div>
                        <div class="horae-multiselect-actions">
                            <button id="horae-btn-agenda-select-all" class="horae-icon-btn small" title="全选">
                                <i class="fa-solid fa-check-double"></i>
                            </button>
                            <button id="horae-btn-agenda-delete" class="horae-icon-btn small danger" title="删除选中">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                            <button id="horae-btn-agenda-cancel-select" class="horae-icon-btn small" title="取消多选">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                    <div id="horae-agenda-list" class="horae-agenda-list">
                        <div class="horae-empty-hint">暂无待办事项</div>
                    </div>
                </div>
                
                <!-- 事件时间线区域 -->
                <div class="horae-timeline-header">
                    <span>事件时间线</span>
                    <div class="horae-timeline-controls">
                        <select id="horae-timeline-filter" class="horae-select" title="筛选事件级别">
                            <option value="all">全部</option>
                            <option value="关键">关键</option>
                            <option value="重要">重要</option>
                            <option value="一般">一般</option>
                            <option value="摘要">摘要</option>
                        </select>
                        <button id="horae-btn-timeline-multiselect" class="horae-icon-btn" title="多选模式">
                            <i class="fa-solid fa-check-double"></i>
                        </button>
                        <button id="horae-btn-scan-all" class="horae-icon-btn" title="刷新时间线">
                            <i class="fa-solid fa-rotate"></i>
                        </button>
                    </div>
                </div>
                <div class="horae-timeline-search-row">
                    <i class="fa-solid fa-magnifying-glass horae-search-icon"></i>
                    <input type="text" id="horae-timeline-search" class="horae-search-input" placeholder="搜索事件关键字...">
                </div>
                <!-- 时间线多选模式工具栏 -->
                <div id="horae-timeline-multiselect-bar" class="horae-multiselect-bar" style="display: none;">
                    <div class="horae-multiselect-info">
                        <span id="horae-timeline-selected-count">0</span> 项已选
                    </div>
                    <div class="horae-multiselect-actions">
                        <button id="horae-btn-timeline-select-all" class="horae-icon-btn small" title="全选">
                            <i class="fa-solid fa-check-double"></i>
                        </button>
                        <button id="horae-btn-timeline-delete" class="horae-icon-btn small danger" title="删除选中">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                        <button id="horae-btn-timeline-cancel-select" class="horae-icon-btn small" title="取消多选">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                </div>
                <div id="horae-timeline-list" class="horae-timeline-list">
                    <div class="horae-empty-state">
                        <i class="fa-regular fa-clock"></i>
                        <span>暂无记录的事件</span>
                    </div>
                </div>
            </div>
            
            <!-- 角色页 -->
            <div id="horae-tab-characters" class="horae-tab-content">
                <div class="horae-subsection">
                    <div class="horae-subsection-title">在场角色</div>
                    <div id="horae-present-characters" class="horae-character-list">
                        <div class="horae-empty-hint">暂无记录</div>
                    </div>
                </div>
                
                <div class="horae-subsection">
                    <div class="horae-subsection-title">
                        好感度
                        <button id="horae-affection-toggle" class="horae-eye-toggle" title="显示/隐藏好感度">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                    </div>
                    <div id="horae-affection-list" class="horae-affection-list">
                        <div class="horae-empty-hint">暂无好感度记录</div>
                    </div>
                </div>
                
                <div class="horae-subsection">
                    <div class="horae-subsection-title">角色</div>
                    <div id="horae-npc-list" class="horae-npc-list">
                        <div class="horae-empty-hint">暂无角色记录</div>
                    </div>
                </div>
            </div>
            
            <!-- 物品页 -->
            <div id="horae-tab-items" class="horae-tab-content">
                <div class="horae-items-toolbar">
                    <div class="horae-items-header">
                        <span>物品追踪列表</span>
                        <div class="horae-items-controls">
                            <select id="horae-items-holder-filter" class="horae-select" title="筛选持有人">
                                <option value="all">所有人</option>
                            </select>
                            <select id="horae-items-filter" class="horae-select" title="筛选物品级别">
                                <option value="all">全部</option>
                                <option value="关键">关键</option>
                                <option value="重要">重要</option>
                                <option value="一般">一般</option>
                            </select>
                            <button id="horae-btn-items-refresh" class="horae-icon-btn" title="刷新物品列表">
                                <i class="fa-solid fa-rotate"></i>
                            </button>
                        </div>
                    </div>
                    <div class="horae-items-search-row">
                        <i class="fa-solid fa-magnifying-glass horae-search-icon"></i>
                        <input type="text" id="horae-items-search" class="horae-search-input" placeholder="搜索物品名、持有者、位置...">
                    </div>
                </div>
                <!-- 多选模式工具栏 -->
                <div id="horae-items-multiselect-bar" class="horae-multiselect-bar" style="display: none;">
                    <div class="horae-multiselect-info">
                        <span id="horae-items-selected-count">0</span> 项已选
                    </div>
                    <div class="horae-multiselect-actions">
                        <button id="horae-btn-items-select-all" class="horae-icon-btn small" title="全选">
                            <i class="fa-solid fa-check-double"></i>
                        </button>
                        <button id="horae-btn-items-delete" class="horae-icon-btn small danger" title="删除选中">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                        <button id="horae-btn-items-cancel-select" class="horae-icon-btn small" title="取消多选">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                </div>
                <div class="horae-items-hint">
                    <i class="fa-solid fa-hand-pointer"></i> 长按物品进入多选模式
                </div>
                <div id="horae-items-full-list" class="horae-items-full-list">
                    <div class="horae-empty-state">
                        <i class="fa-solid fa-box-open"></i>
                        <span>暂无追踪的物品</span>
                    </div>
                </div>
            </div>
            
            <!-- 设置页 -->
            <div id="horae-tab-settings" class="horae-tab-content">
                <div class="horae-settings-section">
                    <div class="horae-section-header">
                        <i class="fa-solid fa-toggle-on"></i>
                        基本设置
                    </div>
                    
                    <div class="horae-setting-item">
                        <label>
                            <input type="checkbox" id="horae-setting-enabled" checked>
                            启用 Horae
                        </label>
                    </div>
                    
                    <div class="horae-setting-item">
                        <label>
                            <input type="checkbox" id="horae-setting-auto-parse" checked>
                            自动解析AI回复中的标签
                        </label>
                    </div>
                    
                    <div class="horae-setting-item">
                        <label>
                            <input type="checkbox" id="horae-setting-inject-context" checked>
                            自动注入状态上下文
                        </label>
                    </div>
                    
                    <div class="horae-setting-item">
                        <label>
                            <input type="checkbox" id="horae-setting-show-panel" checked>
                            显示消息元数据面板
                        </label>
                    </div>
                    
                    <div class="horae-setting-item">
                        <label>
                            <input type="checkbox" id="horae-setting-show-top-icon" checked>
                            显示顶部导航栏图标
                        </label>
                        <span class="horae-setting-hint">
                            关闭后顶部图标完全隐藏，不留空位。可通过扩展面板（积木图标）中的「Horae 时光记忆」栏位重新开启。
                        </span>
                    </div>
                    
                    <div class="horae-setting-item">
                        <label>
                            面板宽度
                            <input type="number" id="horae-setting-panel-width" min="50" max="100" value="100">
                        </label>
                        <span class="horae-setting-hint">
                            消息面板占聊天区域的宽度百分比（50-100）。宽屏美化可调低避免溢出。
                        </span>
                    </div>
                </div>

                <div class="horae-settings-section">
                    <div class="horae-section-header">
                        <i class="fa-solid fa-palette"></i>
                        外观设置
                    </div>
                    
                    <div class="horae-setting-item">
                        <label>
                            插件主题
                            <select id="horae-setting-theme-mode" class="horae-select">
                                <option value="dark">夜间模式</option>
                                <option value="light">日间模式</option>
                            </select>
                        </label>
                        <div class="horae-theme-buttons">
                            <button id="horae-btn-theme-import" class="horae-icon-btn" title="导入美化">
                                <i class="fa-solid fa-file-import"></i>
                            </button>
                            <button id="horae-btn-theme-export" class="horae-icon-btn" title="导出当前美化">
                                <i class="fa-solid fa-file-export"></i>
                            </button>
                            <button id="horae-btn-theme-delete" class="horae-icon-btn" title="删除当前自定义美化">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                        <span class="horae-setting-hint">
                            <i class="fa-solid fa-circle-info"></i>
                            选择内置主题或导入的自定义美化。导入美化文件（.json）后会出现在下拉列表中。
                        </span>
                    </div>
                    
                    <div class="horae-setting-item">
                        <div class="horae-section-header horae-collapse-header" id="horae-css-collapse-toggle" style="border-bottom:none; margin-bottom:0; padding-bottom:0;">
                            自定义CSS
                            <i class="fa-solid fa-chevron-down horae-collapse-icon collapsed"></i>
                        </div>
                        <div id="horae-css-collapse-body" style="display: none;">
                            <span class="horae-setting-hint" style="margin-bottom: 8px;">
                                <i class="fa-solid fa-circle-info"></i>
                                输入自定义CSS覆盖插件样式。适合进阶用户微调配色。修改后切换焦点即生效。
                            </span>
                            <textarea id="horae-custom-css" class="horae-prompt-textarea" rows="6" placeholder="/* 在此输入自定义CSS */"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="horae-settings-section">
                    <div class="horae-section-header">
                        <i class="fa-solid fa-sliders"></i>
                        高级设置
                    </div>
                    
                    <div class="horae-setting-item">
                        <label>
                            上下文深度
                            <input type="number" id="horae-setting-context-depth" min="0" max="999" value="15">
                        </label>
                        <span class="horae-setting-hint">
                            <i class="fa-solid fa-circle-info"></i>
                            控制发送给AI的"一般"级别剧情轨迹数量：<br>
                            0 = 不发送一般事件（重要/关键照发）<br>
                            15 = 发送最近15条一般事件（默认）<br>
                            数字越大发送越多，Token消耗越高
                        </span>
                    </div>
                    
                    <div class="horae-setting-item">
                        <label>
                            注入位置
                            <input type="number" id="horae-setting-injection-position" min="0" max="10" value="1">
                        </label>
                        <span class="horae-setting-hint">
                            <i class="fa-solid fa-circle-info"></i>
                            Horae状态信息插入到AI提示词的哪个位置：<br>
                            0 = 最末尾（紧贴最新消息）<br>
                            1 = 倒数第二（推荐，给AI留思考空间）<br>
                            数字越大越靠前
                        </span>
                    </div>
                </div>
                
                <div class="horae-settings-section">
                    <div class="horae-section-header">
                        <i class="fa-solid fa-table-cells"></i>
                        自定义表格
                    </div>
                    <span class="horae-setting-hint" style="margin-bottom: 12px;">
                        <i class="fa-solid fa-circle-info"></i>
                        创建Excel风格表格，让AI按你的需求填写特定信息。<br>
                        长按表头可添加/删除行列。每个表格可设置提示词指导AI如何填写。<br>
                        <strong>本地表格</strong>跟随当前对话保存；<strong>全局表格</strong>所有对话共享。点击表格名称前的图标可切换。<br>
                        🔒 锁定行列可防止AI修改特定内容。
                    </span>
                    
                    <div id="horae-custom-tables-list" class="horae-custom-tables-list">
                        <!-- 动态生成 -->
                    </div>
                    
                    <div class="horae-table-buttons">
                        <button id="horae-btn-add-table-local" class="horae-btn-add-table">
                            <i class="fa-solid fa-plus"></i> 添加本地表格
                        </button>
                        <button id="horae-btn-add-table-global" class="horae-btn-add-table">
                            <i class="fa-solid fa-globe"></i> 添加全局表格
                        </button>
                        <button id="horae-btn-import-table" class="horae-btn-import-table">
                            <i class="fa-solid fa-upload"></i> 导入表格
                        </button>
                        <input type="file" id="horae-import-table-file" accept=".json" style="display:none;">
                    </div>
                </div>
                
                <div class="horae-settings-section">
                    <div class="horae-section-header">
                        <i class="fa-solid fa-paper-plane"></i>
                        发送给AI的内容
                    </div>
                    <span class="horae-setting-hint" style="margin-bottom: 12px;">
                        <i class="fa-solid fa-circle-info"></i>
                        控制哪些信息会随提示词发送给AI。关闭可节省Token，但AI将无法"记住"这些内容。
                    </span>
                    <div id="horae-token-counter" style="margin-bottom: 12px; padding: 8px 12px; background: var(--horae-bg); border: 1px solid var(--horae-border); border-radius: var(--horae-radius-sm); font-size: 12px; color: var(--horae-text-muted); display: flex; align-items: center; gap: 8px;">
                        <i class="fa-solid fa-microchip" style="color: var(--horae-primary-light);"></i>
                        当前注入 Token：<strong id="horae-token-value" style="color: var(--horae-primary-light);">计算中...</strong>
                    </div>
                    
                    <div class="horae-setting-item">
                        <label>
                            <input type="checkbox" id="horae-setting-send-timeline" checked>
                            剧情轨迹
                        </label>
                        <span class="horae-setting-sub-hint">历史事件摘要、相对时间计算。关闭后AI无法知道"几天前"发生了什么。</span>
                    </div>
                    
                    <div class="horae-setting-item">
                        <label>
                            <input type="checkbox" id="horae-setting-send-characters" checked>
                            角色信息
                        </label>
                        <span class="horae-setting-sub-hint">在场角色、服装描述、好感度、角色信息。关闭后AI可能描写错误的服装。</span>
                    </div>
                    
                    <div class="horae-setting-item">
                        <label>
                            <input type="checkbox" id="horae-setting-send-items" checked>
                            物品栏
                        </label>
                        <span class="horae-setting-sub-hint">当前持有的物品及位置。关闭后AI可能"凭空"取出不存在的物品。</span>
                    </div>
                </div>
                
                <div class="horae-settings-section">
                    <div class="horae-section-header horae-collapse-header" id="horae-prompt-collapse-toggle">
                        <i class="fa-solid fa-scroll"></i>
                        自定义提示词
                        <i class="fa-solid fa-chevron-down horae-collapse-icon collapsed"></i>
                    </div>
                    <div id="horae-prompt-collapse-body" style="display: none;">
                        <span class="horae-setting-hint" style="margin-bottom: 12px;">
                            <i class="fa-solid fa-circle-info"></i>
                            自定义发送给AI的规则提示词。修改后AI将按你的规则输出标签。
                        </span>
                        
                        <div class="horae-prompt-editor-group">
                            <div class="horae-prompt-editor-header">
                                <span>系统注入提示词</span>
                                <button id="horae-btn-reset-system-prompt" class="horae-btn-reset-prompt" title="恢复默认">
                                    <i class="fa-solid fa-rotate-left"></i> 恢复默认
                                </button>
                            </div>
                            <textarea id="horae-custom-system-prompt" class="horae-prompt-textarea" rows="6" placeholder="留空使用默认提示词..."></textarea>
                            <div class="horae-prompt-char-count">
                                <span id="horae-system-prompt-count">0</span> 字符
                            </div>
                        </div>
                        
                        <div class="horae-prompt-editor-group" style="margin-top: 12px;">
                            <div class="horae-prompt-editor-header">
                                <span>AI 智能摘要提示词</span>
                                <button id="horae-btn-reset-batch-prompt" class="horae-btn-reset-prompt" title="恢复默认">
                                    <i class="fa-solid fa-rotate-left"></i> 恢复默认
                                </button>
                            </div>
                            <textarea id="horae-custom-batch-prompt" class="horae-prompt-textarea" rows="6" placeholder="留空使用默认提示词..."></textarea>
                            <div class="horae-prompt-char-count">
                                <span id="horae-batch-prompt-count">0</span> 字符
                            </div>
                        </div>

                        <div class="horae-prompt-editor-group" style="margin-top: 12px;">
                            <div class="horae-prompt-editor-header">
                                <span>AI 分析提示词</span>
                                <button id="horae-btn-reset-analysis-prompt" class="horae-btn-reset-prompt" title="恢复默认">
                                    <i class="fa-solid fa-rotate-left"></i> 恢复默认
                                </button>
                            </div>
                            <textarea id="horae-custom-analysis-prompt" class="horae-prompt-textarea" rows="6" placeholder="留空使用默认提示词..."></textarea>
                            <div class="horae-prompt-char-count">
                                <span id="horae-analysis-prompt-count">0</span> 字符
                            </div>
                        </div>

                        <div class="horae-prompt-editor-group" style="margin-top: 12px;">
                            <div class="horae-prompt-editor-header">
                                <span>表格填写规则提示词</span>
                                <button id="horae-btn-reset-tables-prompt" class="horae-btn-reset-prompt" title="恢复默认">
                                    <i class="fa-solid fa-rotate-left"></i> 恢复默认
                                </button>
                            </div>
                            <textarea id="horae-custom-tables-prompt" class="horae-prompt-textarea" rows="6" placeholder="留空使用默认提示词..."></textarea>
                            <div class="horae-prompt-char-count">
                                <span id="horae-tables-prompt-count">0</span> 字符
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="horae-settings-section">
                    <div class="horae-section-header">
                        <i class="fa-solid fa-database"></i>
                        数据管理
                    </div>
                    
                    <div class="horae-data-buttons-grid">
                        <button id="horae-btn-scan-history" class="horae-data-btn primary" title="扫描所有消息中的&lt;horae&gt;和&lt;horaeevent&gt;标签，补全缺失的元数据（不消耗生成次数）">
                            <i class="fa-solid fa-magnifying-glass-chart"></i>
                            <span>扫描标签</span>
                        </button>
                        <button id="horae-btn-ai-scan" class="horae-data-btn primary" title="用AI分析历史消息，提取剧情事件和物品（自动分批，可撤销）">
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                            <span>AI智能摘要</span>
                        </button>
                        <button id="horae-btn-export" class="horae-data-btn">
                            <i class="fa-solid fa-file-export"></i>
                            <span>导出</span>
                        </button>
                        <button id="horae-btn-import" class="horae-data-btn">
                            <i class="fa-solid fa-file-import"></i>
                            <span>导入</span>
                        </button>
                        <button id="horae-btn-undo-ai-scan" class="horae-data-btn danger" title="清除AI智能摘要生成的所有事件和物品数据">
                            <i class="fa-solid fa-rotate-left"></i>
                            <span>撤销摘要</span>
                        </button>
                        <button id="horae-btn-clear" class="horae-data-btn danger">
                            <i class="fa-solid fa-trash-can"></i>
                            <span>清除</span>
                        </button>
                    </div>
                </div>
                
                <div class="horae-about">
                    <p>Horae v1.4.0 | 作者: SenriYuki</p>
                    <p>基于时间锚点的AI记忆增强系统</p>
                </div>
            </div>
        </div>
    </div>
</div>